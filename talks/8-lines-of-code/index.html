<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/learning-notes/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/learning-notes/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/learning-notes/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/learning-notes/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>8 Lines of Code | Notes</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="8 Lines of Code" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Keyvan Akbary learning notes" /> <meta property="og:description" content="Keyvan Akbary learning notes" /> <meta property="og:site_name" content="Notes" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="8 Lines of Code" /> <script type="application/ld+json"> {"headline":"8 Lines of Code","description":"Keyvan Akbary learning notes","@type":"WebPage","url":"/learning-notes/talks/8-lines-of-code/","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/learning-notes/" class="site-title lh-tight"> Notes </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/learning-notes/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/learning-notes/articles/" class="nav-list-link">Articles</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/learning-notes/books/" class="nav-list-link">Books</a><ul class="nav-list "></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/learning-notes/talks/" class="nav-list-link">Talks</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/learning-notes/papers/" class="nav-list-link">Papers</a><ul class="nav-list "></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Notes" aria-label="Search Notes" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/keyvanakbary/learning-notes" class="site-button" > Learning Notes on GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/learning-notes/talks/">Talks</a></li> <li class="breadcrumb-nav-list-item"><span>8 Lines of Code</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="8-lines-of-code"> <a href="#8-lines-of-code" class="anchor-heading" aria-labelledby="8-lines-of-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://www.infoq.com/presentations/8-lines-code-refactoring">8 Lines of Code</a> </h1> <p>Simplicity is good because</p> <blockquote> <p>I am stupid to work otherwise. Fancy code befuddles me.</p> </blockquote> <p>The problem with magic: Things happen that I don’t understand. Sometimes magic doesn’t work, so I don’t know how it works.</p> <p>Annotations is an example of magic. Here is where simplicity goes out of window. This is not simple.</p> <p>This <em>simple</em> thing is actually increasing the complexity massively.</p> <p>How do you explain all these magic to a person without much experience? How do you explain a <em>Dynamic Proxy</em>? With Dynamic Proxy you need to do <em>special things</em> to make it work, like adding <code class="language-plaintext highlighter-rouge">virtual</code> to every method or avoiding returning <code class="language-plaintext highlighter-rouge">this</code>. People grow with these things and will start spreading this kind of behaviour without really understanding why they do it. This is actually cargo cult.</p> <p>Some teams use frameworks and tools that have so much magic that they start looking for people that know about those things because teaching all that magic takes a lot of time.</p> <p>With annotations those simple lines of code become way more complex than it should be.</p> <p>Love platforms, hate frameworks. Frameworks have a tendency to introduce magic in your system.</p> <blockquote> <p>If you find you need an extension to your IDE to understand what’s going on. It’s probably not simple.</p> </blockquote> <p>What’s the core problem behind a problem (like wanting a <em>Dynamic Proxy</em>). <strong>Can I change my problem so I no longer need those things?</strong></p> <p>We can avoid the proxy entirely if we unify the interface for all of our methods (refactor parameters to objects, Commands), changing our problem to simplify the solution. Now that we have a common interface, we can do basic composition instead of proxying stuff at runtime.</p> <p>From</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">Deactivate</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="kt">string</span> <span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="nf">GetById</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">item</span><span class="p">.</span><span class="nf">Deactivate</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Reactivate</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="n">DateTime</span> <span class="n">effective</span><span class="p">,</span> <span class="kt">string</span> <span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="nf">GetById</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
    <span class="n">item</span><span class="p">.</span><span class="nf">Reactivate</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>To</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="nc">Handles</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">T</span><span class="p">:</span><span class="n">Command</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">T</span> <span class="n">command</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">DeactivatedCommand</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="nf">GetById</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
    <span class="n">item</span><span class="p">.</span><span class="nf">Deactivate</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">ReactivateCommand</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="nf">GetById</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
    <span class="n">item</span><span class="p">.</span><span class="nf">Reactivate</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now that we have a common interface, would have Loggers, Transactions, etc. in the same way we had annotations.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LoggingHandler</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">Handles</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">T</span><span class="p">:</span><span class="n">Command</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Handles</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">next</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">LoggingHandler</span><span class="p">(</span><span class="n">Handles</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">next</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">T</span> <span class="n">command</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">myLoggingFramework</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
        <span class="n">next</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The less magic I have, the faster I get onboard.</p> <p>IoC container. Before having an injection container, we used to pass dependencies as parameters to constructors. Now we have all this boilerplate for injecting and passing parameters everywhere.</p> <p>You can pass dependencies to handlers so we avoid having constructors.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Deactivate</span><span class="p">(</span><span class="n">ItemRepository</span> <span class="n">repository</span><span class="p">,</span> <span class="n">DeactivatedCommand</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="nf">GetById</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
    <span class="n">item</span><span class="p">.</span><span class="nf">Deactivate</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now the problem we have is that we lost the common interface!</p> <p>How can we do the equivalent of dependency injection inside a functional dependency</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>We can close one of the parameters with a lambda (partial application).</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">add5</span> <span class="p">=&gt;</span> <span class="n">c</span> <span class="p">=&gt;</span> <span class="nf">Add</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</code></pre></div></div> <p>Now we can recover our common interface for our commands</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Deactivate</span><span class="p">(</span><span class="n">ItemRepository</span> <span class="n">repository</span><span class="p">,</span> <span class="n">DeactivatedCommand</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="nf">GetById</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
    <span class="n">item</span><span class="p">.</span><span class="nf">Deactivate</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">nodepends</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">Deactivate</span><span class="p">(</span><span class="k">new</span> <span class="nf">ItemRepository</span><span class="p">(),</span> <span class="n">x</span><span class="p">);</span>
</code></pre></div></div> <p>IoC containers solve a problem that maybe you don’t have. If you had a UI program with lots of complex nested dependencies then maybe is the right tool. But for most cases IoC containers are too much.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">Bootstrap</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">handlers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">Deactivate</span><span class="p">(</span><span class="k">new</span> <span class="nf">ItemRepository</span><span class="p">(),</span> <span class="n">x</span><span class="p">));</span>
    <span class="n">handlers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">Reactivate</span><span class="p">(</span><span class="k">new</span> <span class="nf">ItemRepository</span><span class="p">(),</span> <span class="n">x</span><span class="p">));</span>
    <span class="n">handlers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">CheckIn</span><span class="p">(</span><span class="k">new</span> <span class="nf">ItemRepository</span><span class="p">(),</span> <span class="k">new</span> <span class="nf">BarService</span><span class="p">(),</span> <span class="n">x</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p>How many use cases do you have? 15 lines of code could be completely fine. A junior person would totally understand.</p> <p>Feel the pain of passing dependencies and setting up complex structures. A problem with IoC containers is that they make it very easy to do things that you shouldn’t be doing.</p> <p>What about adding a fresh repository per request? (Dependencies life-cycle).</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">Bootstrap</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">handlers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">Deactivate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ItemRepository</span><span class="p">(),</span> <span class="n">x</span><span class="p">));</span>
    <span class="n">handlers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">Reactivate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ItemRepository</span><span class="p">(),</span> <span class="n">x</span><span class="p">));</span>
    <span class="n">handlers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="nf">CheckIn</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">ItemRepository</span><span class="p">(),</span> <span class="k">new</span> <span class="nf">BarService</span><span class="p">(),</span> <span class="n">x</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p>Abstract Factory is too complex. You can write the same thing simply and without any tools.</p> <p>Because a common interface I can do a lot of stuff, our previous Logger handler works the same, probably we don’t need the class.</p> <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">Log</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">command</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">next</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span><span class="p">:</span><span class="n">Command</span> <span class="p">{</span>
    <span class="n">myLoggingFramework</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
    <span class="nf">next</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>We are not usign any of the tools, we can just pass this function around.</p> <p><strong>Understand the problem a tool or idea solves well.</strong></p> <p>Make your tools redundant. Can I change my problem to avoid having that?</p> <p>You should feel pain while passing tons of dependencies across many levels, tools hide problems. They mask problems.</p> <blockquote> <p>If you need to add stuff to your IDE you are probably on the wrong path.</p> </blockquote> <p>A good system shouldn’t need a tool.</p> <p>When we talk about simplicity, we are also talking about tools.</p> <blockquote> <p>You own all code in your project.</p> <p>Your boss doesn’t care if the bug happened in someone else’s library!</p> </blockquote> <p>Sometimes they bring magic to your software, and at some point in time it will break and you won’t know how to fix it.</p> <p>Simplicity is about minimising dependencies, understanding the problems we solve.</p> <p>Try to minimise external dependencies!</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
